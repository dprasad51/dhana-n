<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Badminton Bracket</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151923; --muted:#9aa4b2; --accent:#49a8ff; --text:#f2f5f9;
    --win:#22c55e; --loss:#ef4444; --neutral:#7b88a8;
    --box-w:170px; --box-h:50px; --col-gap:170px; --row-gap:26px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  header{padding:12px 16px;background:#121723;display:flex;flex-wrap:wrap;gap:10px;align-items:center;border-bottom:1px solid #1e2430;position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:18px}
  input,select,textarea{padding:6px 8px;border:1px solid #1f2633;background:#0e1320;color:var(--text);border-radius:6px}
  textarea{width:220px;height:60px}
  .btn{padding:6px 10px;border:1px solid #1f2633;background:#121a2b;color:var(--text);border-radius:6px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#2a82ff,#1b73f8)}
  .chiplist{display:flex;gap:6px;flex-wrap:wrap;max-width:100%}
  .chip{padding:4px 8px;border-radius:999px;background:#0e1320;border:1px solid #203147;display:inline-flex;align-items:center;gap:6px}
  .chip button{background:none;border:none;color:#9aa4b2;cursor:pointer}
  main{display:grid;grid-template-columns:1fr 320px;gap:16px;padding:12px}
  .board{position:relative;overflow:auto;border:1px solid #1e2430;border-radius:10px;background:#101520;min-height:80vh}
  .board-inner{position:relative;margin:30px;min-width:1000px;min-height:600px}
  .box{width:var(--box-w);height:var(--box-h);background:#121a2b;border:2px solid var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:600;position:absolute;transition:border-color .2s}
  .box.win{border-color:var(--win)} .box.loss{border-color:var(--loss)}
  .champ{border-color:gold;color:gold;background:#1b1b0f}
  svg{position:absolute;inset:0;pointer-events:none}
  .edge{stroke:var(--neutral);stroke-width:2}
  .edge.win{stroke:var(--win)}
  .edge.loss{stroke:var(--loss)}
  .scorecard{
    position:absolute;transform:translate(-50%,-130%);
    background:var(--panel);border:1px solid #202637;border-radius:8px;padding:6px 8px;
    display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center;
    z-index:10;min-width:260px
  }
  .scorecard .lab{font-size:12px;color:#d9e6ff;white-space:nowrap;max-width:320px;overflow:hidden;text-overflow:ellipsis}
  .scorecard input{width:50px;text-align:center}
  aside{border:1px solid #1e2430;border-radius:10px;background:#111520;padding:10px;overflow:auto}
  table{width:100%;font-size:12px;border-spacing:0 6px}
  th{color:var(--muted);text-align:left;position:sticky;top:0;background:#0b1019}
  td.win{color:var(--win)} td.loss{color:var(--loss)}
  .confetti{position:absolute;width:8px;height:8px;background:gold;animation:fall 2.2s linear forwards}
  @keyframes fall{to{transform:translateY(220px) rotate(540deg);opacity:0}}
@media print {
  .edge.win  { stroke: #22c55e !important; } /* green */
  .edge.loss { stroke: #ef4444 !important; } /* red */
  .edge      { stroke-width:2; vector-effect:non-scaling-stroke; shape-rendering:crispEdges; }
}
@media print {
  header, aside { display:none !important; }
  body { background:#fff; color:#000; }

  .board { 
    overflow:visible !important; 
    border:none !important;
    height:auto !important; 
    width:auto !important;
  }

  /* scale entire board (boxes + svg together) */
  .board-inner {
    margin:0 auto !important;
    transform: scale(0.65);   /* adjust for 8/16/32 players */
    transform-origin: top left;
  }

  svg, #lines {
    width:100% !important;
    height:100% !important;
    overflow:visible !important;
  }


  .edge.win  { stroke:#22c55e !important; }  /* green winner */
  .edge.loss { stroke:#ef4444 !important; }  /* red loser */
  .edge      { stroke-width:2; vector-effect:non-scaling-stroke; }


}

</style>
</head>
<body>
<header>
  <h1 id="title">üè∏ Badminton Bracket</h1>

  <input id="playerName" placeholder="Add player"/>
  <button class="btn" id="addBtn">Ôºã</button>
  <button class="btn" id="clearBtn">Clear</button>
  <textarea id="bulk" placeholder="Paste names (comma / new lines)"></textarea>
  <button class="btn" id="bulkBtn">Bulk</button>
  <div class="chiplist" id="chips"></div>

  <input id="tName" placeholder="Tournament name"/>
  <input id="tDate" type="date"/>
  <select id="matchType">
    <option value="singles" selected>Singles</option>
    <option value="doubles">Doubles (auto-pair)</option>
  </select>
  <select id="bestOf">
    <option value="1">Single game</option>
    <option value="3" selected>Best of 3</option>
  </select>
  <label><input type="checkbox" id="shuffle"/> Randomize</label>

  <button class="btn primary" id="buildBtn">Build</button>
  <button class="btn" id="resetBtn">Reset</button>
  <button class="btn" id="exportBtn">Export</button>
  <input id="importFile" type="file" accept="application/json" style="display:none"/>
  <button class="btn" id="importBtn">Import</button>
  <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
  <span id="count">0 players</span>
</header>

<main>
  <section class="board">
    <div class="board-inner" id="board">
      <svg id="lines" width="1200" height="800"></svg>
    </div>
  </section>
  <aside>
    <h3>üìä Stats</h3>
    <table>
      <thead><tr><th>Player / Team</th><th>P</th><th>W</th><th>L</th></tr></thead>
      <tbody id="statsBody"></tbody>
    </table>
  </aside>
</main>

<script>
(function(){
  const S={players:[],entries:[],rounds:[],stats:new Map(),meta:{},settings:{bestOf:3,matchType:'singles'}};
  const q=id=>document.getElementById(id);
  const board=q('board'); let svg=q('lines'); const statsBody=q('statsBody'); const chips=q('chips');

  const el=(t,c,s)=>{const x=document.createElement(t);if(c)x.className=c;if(s)Object.assign(x.style,s);return x};
  const esc=s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  function updateCount(){q('count').textContent=`${S.players.length} player${S.players.length===1?'':'s'}`;}
  function drawChips(){chips.innerHTML='';S.players.forEach((p,i)=>{const c=el('div','chip');c.innerHTML=`<span>${esc(p.name)}</span>`;const b=el('button');b.textContent='‚úñ';b.onclick=()=>{S.players.splice(i,1);drawChips();updateCount();};c.appendChild(b);chips.appendChild(c);});}

  q('addBtn').onclick=()=>{const v=q('playerName').value.trim();if(!v)return;S.players.push({name:v});q('playerName').value='';drawChips();updateCount();};
  q('playerName').addEventListener('keydown',e=>{if(e.key==='Enter')q('addBtn').click();});
  q('bulkBtn').onclick=()=>{q('bulk').value.split(/[,\r\n]+/).map(s=>s.trim()).filter(Boolean).forEach(n=>S.players.push({name:n}));q('bulk').value='';drawChips();updateCount();};
  q('clearBtn').onclick=()=>{S.players=[];drawChips();updateCount();};

  const BW=170,BH=50,CG=170,RG=26;
  const topFor=i=>i*(BH+RG);const cy=t=>t+BH/2;

  function shuffleArr(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
  function resizeSVG(){const boxes=[...board.querySelectorAll('.box')];if(!boxes.length){svg.setAttribute('width',1200);svg.setAttribute('height',800);return;}let maxX=0,maxY=0;boxes.forEach(b=>{const x=parseFloat(b.style.left)+BW,y=parseFloat(b.style.top)+BH;if(x>maxX)maxX=x;if(y>maxY)maxY=y;});svg.setAttribute('width',Math.max(600,maxX+60));svg.setAttribute('height',Math.max(400,maxY+60));}

  q('buildBtn').onclick=()=>{
    if(S.players.length<2){alert('Add players');return;}
    S.settings.matchType=q('matchType').value;
    S.settings.bestOf=parseInt(q('bestOf').value,10);

    let entries=[];
    if(S.settings.matchType==='doubles'){
      if(S.players.length%2){alert('Even number required for doubles');return;}
      for(let i=0;i<S.players.length;i+=2)entries.push(`${S.players[i].name} & ${S.players[i+1].name}`);
    }else entries=S.players.map(p=>p.name);

    if((entries.length&(entries.length-1))!==0){alert('Entries must be power of two');return;}
    if(q('shuffle').checked)shuffleArr(entries);

    S.entries=[...entries];
    S.meta.name=q('tName').value||'Tournament';S.meta.date=q('tDate').value||new Date().toISOString().slice(0,10);
    q('title').textContent=`üè∏ ${S.meta.name} (${S.meta.date})`;
    S.stats.clear();entries.forEach(n=>S.stats.set(n,{P:0,W:0,L:0}));

    board.innerHTML='<svg id="lines"></svg>';svg=q('lines');
    layout(entries);resizeSVG();renderStats();
  };

  q('resetBtn').onclick=()=>{board.innerHTML='<svg id="lines"></svg>';svg=q('lines');S.rounds=[];S.stats.clear();statsBody.innerHTML='';};

  function layout(entries){
    S.rounds=[];let prev=[];
    entries.forEach((name,i)=>prev.push(createBox(name,0,topFor(i),false)));
    const roundsCount=Math.log2(entries.length)|0;
    for(let r=0;r<roundsCount;r++){
      const curr=[];S.rounds[r]=[];
      for(let m=0;m<prev.length/2;m++){
        const A=prev[2*m],B=prev[2*m+1];
        const yA=cy(parseFloat(A.style.top)), yB=cy(parseFloat(B.style.top)), midY=(yA+yB)/2;
        const T=createBox('‚Äî',(r+1)*(BW+CG),midY-BH/2,r===roundsCount-1);

        // geometry
        const ax=parseFloat(A.style.left)+BW, bx=parseFloat(B.style.left)+BW;
        const tx=parseFloat(T.style.left);
        const jx = (ax+tx)/2; // single joint X

        // draw lines
        const hA  = line(ax, yA, jx, yA);
        const vA  = line(jx, Math.min(yA, midY), jx, Math.max(yA, midY));
        const hB  = line(bx, yB, jx, yB);
        const vB  = line(jx, Math.min(yB, midY), jx, Math.max(yB, midY));
        const hF  = line(jx, midY, tx, midY);

        // Scorecard ABOVE the winner box
        const card=el('div','scorecard',{left:(tx+BW/2)+'px',top:(parseFloat(T.style.top))+'px'});
        const label=el('span','lab');label.textContent=`${A.dataset.name} vs ${B.dataset.name}`;label.title=label.textContent;card.appendChild(label);
        const sets=[];for(let i=0;i<S.settings.bestOf;i++){const ia=el('input');ia.type='number';ia.min='0';const ib=el('input');ib.type='number';ib.min='0';sets.push([ia,ib]);card.append(ia,ib);}
        const save=el('button');save.textContent='Save';card.appendChild(save);board.appendChild(card);

        const mo={A,B,T,lines:{hA,vA,hB,vB,hF},card,label,sets,saved:false};
        save.onclick=()=>finalize(mo);
        S.rounds[r].push(mo);curr.push(T);
      }prev=curr;
    }
  }

  function createBox(name,left,top,isChamp){const b=el('div','box'+(isChamp?' champ':''),{left:left+'px',top:top+'px'});b.textContent=name;b.dataset.name=name;board.appendChild(b);return b;}
  function line(x1,y1,x2,y2){const L=document.createElementNS('http://www.w3.org/2000/svg','line');L.setAttribute('x1',x1);L.setAttribute('y1',y1);L.setAttribute('x2',x2);L.setAttribute('y2',y2);L.setAttribute('class','edge');svg.appendChild(L);return L;}

  function setWinForA(mo){
    mo.lines.hA.classList.add('win'); mo.lines.vA.classList.add('win');
    mo.lines.hB.classList.add('loss'); mo.lines.vB.classList.add('loss');
    mo.lines.hF.classList.add('win');
    mo.A.classList.add('win'); mo.B.classList.add('loss');
  }
  function setWinForB(mo){
    mo.lines.hB.classList.add('win'); mo.lines.vB.classList.add('win');
    mo.lines.hA.classList.add('loss'); mo.lines.vA.classList.add('loss');
    mo.lines.hF.classList.add('win');
    mo.B.classList.add('win'); mo.A.classList.add('loss');
  }

  function finalize(mo, presetSets=null){
    if(mo.saved)return;
    let wA=0,wB=0;
    const vals=presetSets || mo.sets.map(([ia,ib])=>[parseInt(ia.value)||0,parseInt(ib.value)||0]);
    vals.forEach(([sa,sb])=>{if(sa>sb)wA++;else if(sb>sa)wB++;});
    if(wA===wB){alert('Tie not allowed');return;}
    const winner=wA>wB?mo.A.dataset.name:mo.B.dataset.name, loser=wA>wB?mo.B.dataset.name:mo.A.dataset.name;

    // forward name & box classes
    mo.T.textContent=winner; mo.T.dataset.name=winner;
    if(wA>wB) setWinForA(mo); else setWinForB(mo);

    // lock inputs
    mo.sets.flat().forEach(i=>i.disabled=true);
    const btn=mo.card.querySelector('button'); if(btn) btn.disabled=true;
    mo.saved=true;

    // stats
    const w=S.stats.get(winner)||{P:0,W:0,L:0};
    const l=S.stats.get(loser)||{P:0,W:0,L:0};
    w.P++;w.W++;l.P++;l.L++;S.stats.set(winner,w);S.stats.set(loser,l);renderStats();

    // refresh next labels
    for(const round of S.rounds){
      for(const next of round){
        if(next.A===mo.T||next.B===mo.T){
          next.label.textContent=`${next.A.dataset.name} vs ${next.B.dataset.name}`;
          next.label.title=next.label.textContent;
        }
      }
    }
    if(mo.T.classList.contains('champ')) sprinkleConfetti(mo.T);
  }

  function renderStats(){statsBody.innerHTML='';for(const [name,s]of S.stats){const tr=document.createElement('tr');tr.innerHTML=`<td>${esc(name)}</td><td>${s.P}</td><td class="win">${s.W}</td><td class="loss">${s.L}</td>`;statsBody.appendChild(tr);}}

  function sprinkleConfetti(box){
    const bx=parseFloat(box.style.left)+BW/2,by=parseFloat(box.style.top)+BH/2;
    for(let i=0;i<60;i++){
      const c=el('div','confetti');
      c.style.left=bx+'px'; c.style.top=by+'px';
      c.style.background=`hsl(${Math.random()*360},100%,50%)`;
      c.style.transform=`translate(${(Math.random()-0.5)*260}px,0)`;
      c.style.animationDuration=(1+Math.random()*2.2)+'s';
      board.appendChild(c);
      setTimeout(()=>c.remove(),2500);
    }
  }

  q('exportBtn').onclick=()=>{const data=JSON.stringify({players:S.players,meta:S.meta,stats:[...S.stats]},null,2);const blob=new Blob([data],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${S.meta.name||'tournament'}.json`;a.click();};
  q('importBtn').onclick=()=>q('importFile').click();
  q('importFile').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const o=JSON.parse(ev.target.result);S.players=o.players||[];S.meta=o.meta||{};S.stats=new Map(o.stats||[]);drawChips();updateCount();renderStats();}catch(err){alert('Bad file')}};r.readAsText(f);};
  window.onbeforeprint = resizeSVG;
window.onbeforeprint = resizeSVG;

})();
</script>
</body>
</html>
